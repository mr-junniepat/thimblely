erDiagram
    %% ========================================
    %% CORE AUTHENTICATION & WORKSPACE
    %% ========================================
    %% SECURITY & RLS REQUIREMENTS:
    %% - Every tenant-scoped table MUST have RLS policies (clients, orders, messages, etc.)
    %% - CASL abilities in workspace_members.permissions drive UI + edge/server pre-checks
    %% - RLS is the final gatekeeper - never rely on CASL alone
    %% - Index workspace_id, user_id, status columns used in RLS WHERE clauses
    %% - Use permissions_version to invalidate JWTs on permission changes
    %% - Store credentials in Supabase Secrets/KMS, not plaintext in DB
    %% - Implement soft deletes (deleted_at) on sensitive tables for GDPR/recovery
    %% - Orders default to draft status, require confirmed_by for state transitions
    %% - Messages have UNIQUE(channel_id, platform_message_id) for webhook idempotency
    %% - mcp_contexts references external pgvector, not stored as JSONB embeddings
    
    %% ACCESS CONTROL RULES:
    %% - Workspace owners: create & manage workspace, invite team members
    %% - Team members: invited by owner, can see/manage clients, measurements, etc.
    %% - Clients: never have workspace access (unless they create their own business)
    %% - Clients can only submit measurements when requested by workspace team
    %% - Removing employee from workspace: they lose access to that workspace only,
    %%   NOT their platform account or other workspaces they may be part of
    
    auth_users ||--|| profiles : "1:1"
    profiles ||--o{ workspaces : "owns"
    profiles ||--o{ workspace_members : "member" "can be member of multiple workspaces"
    profiles ||--o{ notifications : "receives"
    
    workspaces ||--o{ workspace_members : "has" "team members with roles & permissions"
    workspaces ||--o{ workspace_invitations : "invites" "email invites to join workspace"
    workspaces ||--o{ workspace_settings : "has"
    
    %% ========================================
    %% SIX WORKSPACE SERVICES
    %% ========================================
    %% SERVICE 1: CALENDAR
    workspaces ||--o{ events : "schedules"
    workspaces ||--o{ fitting_requests : "sends"
    clients ||--o{ fitting_requests : "receives"
    events ||--o{ event_reminders : "reminds"
    
    %% SERVICE 2: CRM
    workspaces ||--o{ clients : "has" "team manages, clients never access workspace"
    workspaces ||--o{ measurement_templates : "creates" "team members create"
    workspace_members ||--o{ client_interactions : "records" "team members manage"
    workspace_members ||--o{ measurement_requests : "sends" "team members request measurements"
    clients ||--o{ client_interactions : "history"
    clients ||--o{ client_measurements : "submits" "clients fill measurements"
    measurement_templates ||--o{ client_measurements : "template_for"
    measurement_templates ||--o{ measurement_requests : "requested_from"
    clients ||--o{ measurement_requests : "receives"
    clients ||--o{ orders : "places"
    clients ||--o{ invoices : "billed"
    clients ||--o{ messages : "sends/receives" "communication with team"
    
    %% SERVICE 3: FINANCE
    workspaces ||--o{ transactions : "records"
    workspaces ||--o{ financial_goals : "tracks"
    workspaces ||--o{ auto_splits : "configures"
    workspaces ||--o{ invoices : "generates"
    workspaces ||--o{ finance_exports : "generates"
    
    %% SERVICE 4: INVENTORY
    workspaces ||--o{ inventory_items : "tracks"
    inventory_items ||--o{ inventory_movements : "tracks"
    inventory_items ||--o{ order_items : "used_in"
    
    %% SERVICE 5: ORDERS
    workspaces ||--o{ orders : "manages"
    communication_channels ||--o{ orders : "places_from" "WhatsApp/Telegram orders"
    orders ||--o{ order_items : "contains"
    orders ||--o{ invoices : "generates"
    orders ||--o{ events : "linked_to"
    orders ||--o{ deliverables : "generates"
    orders ||--o{ fitting_requests : "triggers" "send fitting request after order complete"
    fitting_requests ||--o{ events : "books" "fitting appointments"
    
    %% SERVICE 6: TEAM
    %% (workspace_members defined above)
    
    %% ========================================
    %% COMMUNICATION & SOCIAL
    %% ========================================
    %% Workspaces connect to WhatsApp Business & Telegram Business
    workspaces ||--o{ communication_channels : "connects" "WhatsApp/Telegram business accounts"
    communication_channels ||--o{ messages : "receives"
    communication_channels ||--o{ orders : "places_from" "orders from WhatsApp/Telegram"
    
    profiles ||--o{ social_media_connections : "personal" "Instagram/TikTok for posting feeds"
    workspaces ||--o{ social_media_connections : "business" "Instagram/TikTok for posting feeds"
    
    profiles ||--o{ feeds : "personal"
    workspaces ||--o{ feeds : "business"
    feeds ||--o{ feed_interactions : "has" "JSONB: likes, comments, shares"
    feeds ||--o{ feed_cross_posts : "shares"
    social_media_connections ||--o{ feed_cross_posts : "uses"
    
    %% ========================================
    %% MARKETPLACE
    %% ========================================
    workspaces ||--o{ marketplace_products : "sells"
    marketplace_products ||--o{ product_interactions : "has" "JSONB: reviews, likes"
    
    %% ========================================
    %% SUBSCRIPTIONS & BILLING
    %% ========================================
    subscription_plans ||--o{ subscription_features : "defines"
    subscription_plans ||--o{ workspace_subscriptions : "offered_in"
    
    workspace_subscriptions ||--o{ subscription_billing : "generates"
    workspace_subscriptions ||--o{ subscription_changes : "tracks"
    
    profiles ||--o{ workspace_subscriptions : "purchases"
    profiles ||--o{ payment_accounts : "connects" "Stripe/PayPal/Paystack/Flutterwave"
    workspaces ||--o{ workspace_subscriptions : "has"
    
    payment_accounts ||--o{ payment_transactions : "processes"
    
    %% ========================================
    %% AI & AUTOMATION
    %% ========================================
    workspaces ||--o{ ai_settings : "configures"
    workspaces ||--o{ ai_automations : "automates"
    workspaces ||--o{ mcp_contexts : "manages" "AI context management"
    
    %% ========================================
    %% ANALYTICS & EVENTS
    %% ========================================
    workspaces ||--o{ analytics_dashboards : "has"
    workspaces ||--o{ system_events : "tracks" "unified event tracking"
    
    %% ========================================
    %% RESOURCES & OPTIMIZATION
    %% ========================================
    workspaces ||--o{ resource_allocations : "has"
    workspaces ||--o{ resource_usage_logs : "tracks"
    workspaces ||--o{ optimization_recommendations : "receives"
    
    %% ========================================
    %% ADS SYSTEM
    %% ========================================
    admin_users ||--o{ ad_campaigns : "creates"
    ad_campaigns ||--o{ boosted_posts : "promotes"
    ad_campaigns ||--o{ ad_analytics : "tracks" "JSONB: impressions, clicks"
    boosted_posts ||--o{ feeds : "boosts"
    
    %% ========================================
    %% PUBLIC EVENTS
    %% ========================================
    profiles ||--o{ public_events : "creates"
    public_events ||--o{ event_registrations : "has"
    public_events ||--o{ payment_transactions : "receives"
    
    %% ========================================
    %% PROFILE & SOCIAL
    %% ========================================
    profiles ||--o{ profile_settings : "has"
    profiles ||--o{ influencer_profiles : "may_be"
    profiles ||--o{ follow_relationships : "follower/following"
    profiles ||--o{ mentions : "receives"
    profiles ||--o{ deliverables : "assigned"
    
    %% ========================================
    %% FILE MANAGEMENT
    %% ========================================
    workspaces ||--o{ file_uploads : "stores"
    
    %% ========================================
    %% TABLE DEFINITIONS
    %% ========================================
    
    auth_users {
        uuid id PK
        text email
    }
    
    profiles {
        uuid id PK
        text email UK
        text role "Business/Customer/Admin - controls workspace access"
        text country_code
        boolean is_verified
        boolean is_active
        boolean owns_workspace "true if they created a business workspace"
        jsonb metadata
    }
    
    workspaces {
        uuid id PK
        uuid owner_id FK "profiles.id"
        text name
        text slug UK
        text business_type
        boolean is_locked
        jsonb settings
        timestamps
    }
    
    workspace_settings {
        uuid id PK
        uuid workspace_id FK
        jsonb notification_preferences
        jsonb module_permissions
        jsonb feature_flags
        timestamps
    }
    
    workspace_members {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK "profiles.id - can be member of multiple workspaces"
        text role "owner/admin/manager/employee/team_member"
        jsonb permissions "CASL abilities - e.g. [create:Order, view:Client, confirm:Invoice]"
        int permissions_version "increment on permission changes to invalidate JWT"
        text invitation_status "pending/active/suspended/removed"
        uuid invited_by FK "profiles.id of who sent invite"
        timestamp removed_at "when removed from workspace"
        uuid removed_by FK "profiles.id of who removed them"
        jsonb removal_reason
        timestamps
        unique(workspace_id, user_id)
    }
    
    workspace_invitations {
        uuid id PK
        uuid workspace_id FK
        text email
        text role
        timestamps
    }
    
    notifications {
        uuid id PK
        uuid user_id FK
        uuid workspace_id FK
        text notification_type
        jsonb data
        boolean is_read
        timestamps
    }
    
    %% SERVICE 1: CALENDAR
    events {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK "workspace member creating event"
        text title
        text event_type "appointment/meeting/fitting/consultation"
        timestamp start_time
        timestamp end_time
        uuid client_id FK
        uuid order_id FK
        uuid fitting_request_id FK "if this is a fitting appointment"
        text location "studio/showroom/virtual"
        text status "scheduled/confirmed/completed/cancelled"
        text description
        jsonb metadata
        timestamps
    }
    
    event_reminders {
        uuid id PK
        uuid event_id FK
        uuid user_id FK
        timestamp reminder_time
        boolean sent
        timestamps
    }
    
    fitting_requests {
        uuid id PK
        uuid workspace_id FK
        uuid client_id FK
        uuid order_id FK "order that triggered this fitting request"
        text request_status "sent/pending/accepted/declined/cancelled"
        text request_message "custom message to client"
        uuid event_id FK "created fitting appointment"
        text communication_method "email/whatsapp/sms/phone"
        boolean email_sent "email notification sent to client"
        timestamp email_sent_at
        boolean client_notified_via_channel
        jsonb available_slots "times designer is available"
        timestamp requested_at
        timestamp accepted_at
        timestamp expires_at "request expires if not accepted"
        timestamps
    }
    
    %% SERVICE 2: CRM
    clients {
        uuid id PK
        uuid workspace_id FK
        uuid profile_id FK "profiles.id - who they are as a user (can be null for businesses)"
        text name
        text email
        text phone
        text client_type "individual/business"
        text status "active/pending/inactive"
        decimal total_revenue
        boolean has_workspace_access "false - clients never access workspace"
        jsonb metadata
        timestamp deleted_at "soft delete for GDPR/recovery"
        timestamps
        index(workspace_id, status, deleted_at) "common RLS filter"
    }
    
    client_interactions {
        uuid id PK
        uuid client_id FK
        uuid workspace_id FK
        text interaction_type
        text description
        jsonb metadata
        timestamps
    }
    
    measurement_templates {
        uuid id PK
        uuid workspace_id FK
        text template_name
        text category
        jsonb measurement_fields
        timestamps
    }
    
    client_measurements {
        uuid id PK
        uuid client_id FK
        uuid measurement_template_id FK
        uuid measurement_request_id FK
        jsonb measurements
        text submission_status "pending/completed/reviewed"
        uuid submitted_by FK "profile ID of client submitting"
        timestamp submitted_at
        timestamps
    }
    
    measurement_requests {
        uuid id PK
        uuid workspace_id FK
        uuid client_id FK
        uuid measurement_template_id FK
        uuid requested_by FK "profile ID of workspace member who requested"
        text request_status "sent/pending/filled/completed"
        text request_message
        timestamp sent_at
        timestamp filled_at
        timestamps
    }
    
    %% SERVICE 3: FINANCE
    transactions {
        uuid id PK
        uuid workspace_id FK
        text transaction_type
        text category
        decimal amount
        jsonb metadata
        timestamps
    }
    
    financial_goals {
        uuid id PK
        uuid workspace_id FK
        text title
        text goal_type
        decimal target_amount
        text status
        jsonb metadata
        timestamps
    }
    
    auto_splits {
        uuid id PK
        uuid workspace_id FK
        text name
        text split_type
        decimal value
        boolean is_active
        timestamps
    }
    
    invoices {
        uuid id PK
        uuid workspace_id FK
        uuid order_id FK
        uuid client_id FK
        text invoice_number UK
        jsonb bill_info
        decimal total_amount
        text status
        jsonb metadata
        timestamps
    }
    
    finance_exports {
        uuid id PK
        uuid workspace_id FK
        text export_type
        text format
        text file_url
        jsonb config
        timestamps
    }
    
    %% SERVICE 4: INVENTORY
    inventory_items {
        uuid id PK
        uuid workspace_id FK
        text sku UK
        text name
        int current_stock
        int min_stock_level
        text status
        jsonb metadata
        timestamps
    }
    
    inventory_movements {
        uuid id PK
        uuid inventory_item_id FK
        uuid workspace_id FK
        text movement_type
        int quantity
        jsonb metadata
        timestamps
    }
    
    %% SERVICE 5: ORDERS
    orders {
        uuid id PK
        uuid workspace_id FK
        uuid client_id FK
        uuid channel_id FK "communication_channels.id - where order came from"
        uuid created_from_context_id FK "mcp_contexts.id if created via AI"
        text order_source "direct/website/whatsapp/telegram/phone"
        text order_number UK
        decimal total_amount
        text status "draft/confirmed/paid/cancelled/fulfilled"
        uuid confirmed_by FK "profiles.id - who confirmed (NULL if draft)"
        timestamp confirmed_at "NULL if draft, timestamp when confirmed"
        timestamp deleted_at "soft delete for GDPR/recovery"
        jsonb metadata "original message, platform ID, confidence score, audit trail"
        timestamps
    }
    
    order_items {
        uuid id PK
        uuid order_id FK
        uuid inventory_item_id FK
        text item_name
        int quantity
        decimal unit_price
        timestamps
    }
    
    deliverables {
        uuid id PK
        uuid workspace_id FK
        uuid assigned_to FK
        text title
        text status
        timestamp due_date
        jsonb metadata
        timestamps
    }
    
    %% COMMUNICATION
    communication_channels {
        uuid id PK
        uuid workspace_id FK
        text channel_type "whatsapp_business/telegram_business/email/sms"
        text channel_name
        text phone_number "for WhatsApp/Telegram"
        text platform_account_id "platform API account ID"
        text credentials_ref "opaque ref to Supabase Secrets/KMS - NEVER store raw keys"
        jsonb config "webhook URLs, auto-responders, etc."
        boolean is_active
        boolean supports_orders "can place orders from this channel"
        jsonb order_settings "auto-confirm, templates, etc."
        timestamp deleted_at "soft delete"
        timestamps
    }
    
    messages {
        uuid id PK
        uuid workspace_id FK
        uuid channel_id FK
        uuid client_id FK
        uuid order_id FK "links to order if this message created an order"
        text direction "inbound/outbound"
        text message_type "text/image/video/order_request/order_confirmation"
        text content
        text platform_message_id "WhatsApp/Telegram message ID for webhook idempotency"
        jsonb media_urls
        jsonb metadata "read receipts, delivery status, webhook retry count, etc."
        boolean is_order_related
        timestamp deleted_at "soft delete for GDPR"
        timestamps
        unique(channel_id, platform_message_id) "webhook idempotency constraint"
    }
    
    %% SOCIAL & FEEDS
    %% NOTE: social_media_connections is for Instagram/TikTok cross-posting feeds
    %% communication_channels is for WhatsApp/Telegram business messaging
    social_media_connections {
        uuid id PK
        uuid user_id FK "for personal feeds"
        uuid workspace_id FK "for business feeds"
        text platform "instagram/tiktok/facebook"
        jsonb credentials
        jsonb metadata
        timestamps
    }
    
    feeds {
        uuid id PK
        uuid user_id FK
        uuid workspace_id FK
        text feed_type
        text caption
        jsonb media_urls
        text visibility
        jsonb interactions "likes, comments, shares"
        int view_count
        timestamps
    }
    
    feed_interactions {
        uuid id PK
        uuid feed_id FK
        uuid user_id FK
        text interaction_type "like/comment/share"
        jsonb data
        timestamps
    }
    
    feed_cross_posts {
        uuid id PK
        uuid feed_id FK
        uuid social_connection_id FK
        text platform
        text status
        jsonb metadata
        timestamps
    }
    
    %% MARKETPLACE
    marketplace_products {
        uuid id PK
        uuid workspace_id FK
        text title
        text description
        text category
        decimal price
        jsonb images
        int stock_quantity
        text status
        jsonb metadata
        timestamps
    }
    
    product_interactions {
        uuid id PK
        uuid product_id FK
        uuid user_id FK
        text interaction_type "review/like"
        jsonb data
        timestamps
    }
    
    %% SUBSCRIPTIONS & BILLING
    subscription_plans {
        uuid id PK
        text plan_name
        decimal monthly_price
        decimal yearly_price
        jsonb features
        boolean is_active
        timestamps
    }
    
    subscription_features {
        uuid id PK
        uuid plan_id FK
        text feature_name
        text feature_module
        boolean is_enabled
        jsonb limits
        timestamps
    }
    
    workspace_subscriptions {
        uuid id PK
        uuid workspace_id FK
        uuid plan_id FK
        text billing_cycle
        text payment_status
        timestamp current_period_start
        timestamp current_period_end
        jsonb metadata
        timestamps
    }
    
    subscription_billing {
        uuid id PK
        uuid subscription_id FK
        text invoice_number
        decimal amount
        text payment_status
        jsonb metadata
        timestamps
    }
    
    subscription_changes {
        uuid id PK
        uuid workspace_id FK
        text change_type
        jsonb old_plan
        jsonb new_plan
        timestamps
    }
    
    payment_transactions {
        uuid id PK
        uuid workspace_id FK
        uuid payment_account_id FK
        text payment_type "subscription/event/ad_campaign"
        text transaction_type "income/expense/refund"
        uuid entity_id FK
        decimal amount
        text currency
        text payment_method
        text gateway "paystack/flutterwave/stripe"
        text status
        jsonb metadata
        timestamps
    }
    
    payment_accounts {
        uuid id PK
        uuid user_id FK "profiles.id"
        text gateway_type "stripe/paypal/paystack/flutterwave"
        text gateway_account_id "connected account ID"
        text account_status "active/disabled/verification_pending"
        jsonb capabilities
        jsonb requirements
        boolean is_default
        timestamps
    }
    
    refunds {
        uuid id PK
        uuid transaction_id FK
        decimal amount
        text reason
        text status
        jsonb metadata
        timestamps
    }
    
    %% AI & AUTOMATION
    ai_settings {
        uuid id PK
        uuid workspace_id FK
        text provider
        text model_name
        jsonb budgets
        jsonb rate_limits
        jsonb custom_prompts
        timestamps
    }
    
    ai_automations {
        uuid id PK
        uuid workspace_id FK
        text automation_type
        jsonb config
        boolean is_active
        jsonb metadata
        timestamps
    }
    
    mcp_contexts {
        uuid id PK
        uuid workspace_id FK
        text context_name
        text context_type
        jsonb context_data
        text vector_store_ref "reference to pgvector or external vector DB - do not store large embeddings in JSONB"
        jsonb metadata
        boolean is_active DEFAULT true
        timestamp expires_at "auto-cleanup old contexts"
        timestamp deleted_at "soft delete for GDPR"
        timestamps
        index(workspace_id, is_active, expires_at) "RLS + active context queries"
    }
    
    %% ANALYTICS & EVENTS
    analytics_dashboards {
        uuid id PK
        uuid workspace_id FK
        text dashboard_name
        text dashboard_type
        jsonb widget_configs
        timestamps
    }
    
    system_events {
        uuid id PK
        uuid workspace_id FK
        uuid user_id FK
        text event_name
        text event_category
        jsonb event_properties
        jsonb device_info
        timestamps
    }
    
    %% RESOURCES & OPTIMIZATION
    resource_allocations {
        uuid id PK
        uuid workspace_id FK
        text resource_type
        decimal allocated
        decimal used
        decimal available
        text allocation_type
        timestamps
    }
    
    resource_usage_logs {
        uuid id PK
        uuid workspace_id FK
        text resource_type
        text usage_type
        decimal quantity_used
        jsonb metadata
        timestamps
    }
    
    optimization_recommendations {
        uuid id PK
        uuid workspace_id FK
        text recommendation_type
        text resource_type
        text recommendation_title
        decimal estimated_savings
        integer priority
        text status
        timestamps
    }
    
    %% ADS SYSTEM
    admin_users {
        uuid id PK
        uuid profile_id FK
        text admin_role
        jsonb permissions
        timestamps
    }
    
    ad_campaigns {
        uuid id PK
        uuid created_by FK
        text campaign_type
        jsonb targeting
        jsonb budget
        jsonb analytics "impressions, clicks, spend"
        text status
        timestamps
    }
    
    boosted_posts {
        uuid id PK
        uuid feed_id FK
        uuid ad_campaign_id FK
        decimal boost_amount
        text boost_duration
        text payment_status
        timestamps
    }
    
    %% PUBLIC EVENTS
    public_events {
        uuid id PK
        uuid creator_id FK
        uuid workspace_id FK
        text title
        text event_type
        text pricing_type
        decimal price
        timestamp start_time
        timestamp end_time
        integer max_attendees
        text status
        jsonb metadata
        timestamps
    }
    
    event_registrations {
        uuid id PK
        uuid event_id FK
        uuid attendee_id FK
        text status
        decimal amount_paid
        timestamps
    }
    
    %% PROFILE & SOCIAL
    profile_settings {
        uuid id PK
        uuid user_id FK
        jsonb privacy_settings
        jsonb notification_preferences
        timestamps
    }
    
    influencer_profiles {
        uuid id PK
        uuid profile_id FK
        text bio
        jsonb specializations
        text verification_status
        timestamps
    }
    
    follow_relationships {
        uuid id PK
        uuid follower_id FK
        uuid following_id FK
        text relationship_type
        UNIQUE(follower_id, following_id)
        timestamps
    }
    
    mentions {
        uuid id PK
        uuid mentioned_user_id FK
        uuid mentioner_id FK
        text entity_type
        uuid entity_id
        boolean is_read
        timestamps
    }
    
    %% FILE MANAGEMENT
    file_uploads {
        uuid id PK
        uuid workspace_id FK
        uuid uploaded_by FK
        text file_type
        text file_name
        text file_url
        bigint file_size
        jsonb metadata
        timestamps
    }
    
    %% Summary: 6 workspace services
    %% SERVICE 1: CALENDAR - events, event_reminders, fitting_requests
    %% SERVICE 2: CRM - clients, client_interactions, client_measurements, measurement_templates, measurement_requests
    %% SERVICE 3: FINANCE - transactions, financial_goals, auto_splits, invoices, finance_exports
    %% SERVICE 4: INVENTORY - inventory_items, inventory_movements
    %% SERVICE 5: ORDERS - orders, order_items, deliverables
    %% SERVICE 6: TEAM - workspace_members, workspace_invitations (defined in core)
    
    %% Optimizations:
    %% ✓ Reduced from ~50 to ~35 tables (30% reduction)
    %% ✓ Consolidated payment tables → payment_transactions with type column
    %% ✓ Merged analytics_events + audit_logs → system_events
    %% ✓ Unified all usage tracking → resource_usage_logs
    %% ✓ Used JSONB for flexible metadata (interactions, configs, etc.)
    %% ✓ Removed Supabase-duplicated functionality (auth_sessions, api_tokens, webhooks, backups)
    %% ✓ Simplified feeds with JSONB interactions column
    %% ✓ Simplified marketplace with JSONB product_interactions

